<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calend√°rio das Aulas - Curso de Scratch</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div id="confirmModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="confirmModalTitle"></h3>
                <button class="close-btn" onclick="closeConfirmModal()">√ó</button>
            </div>
            <div class="modal-body">
                <p id="confirmModalText"></p>
            </div>
            <div class="modal-footer">
                <button id="confirmCancelBtn" class="action-btn secondary" onclick="closeConfirmModal()">Cancelar</button>
                <button id="confirmOkBtn" class="action-btn danger">Confirmar</button>
            </div>
        </div>
    </div>
    
    <div class="main-layout">
        <header class="header">
            <div class="logo">
                <img src="img/scratch.png" height="50px" width="50px" alt="Scratch Logo" id="scratch-logo">
            </div>
            <nav>
                <ul class="nav-menu">
                    <li id="navDiarioClasseAluno"><a href="dashboard.html">Di√°rio de Classe</a></li>
                    <li id="navMateriaisAluno"><a href="materials.html">Materiais</a></li>

                    <li id="navAdmin"><a href="admin.html">Administra√ß√£o de Usu√°rios</a></li>
                    <li id="navBancoDados"><a href="database.html">Banco de Dados</a></li>
                    <li id="navDiarioClasseProf"><a href="teacher-diary.html">Di√°rio de Classe</a></li>
                    <li id="navMateriaisProf"><a href="teacher-materials.html">Materiais</a></li>

                    <li class="dropdown">
                        <a href="#">Links Externos ‚ñº</a>
                        <div class="dropdown-content">
                            <a href="https://scratch.mit.edu/" target="_blank">Scratch Site</a>
                            <a href="https://scratch.mit.edu/projects/editor/" target="_blank">Editor do Scratch</a>
                            <a href="https://scratch.mit.edu/ideas" target="_blank">Ideias de Projetos</a>
                            <a href="https://www.youtube.com/results?search_query=scratch+tutorial+portugu√™s" target="_blank">Tutoriais YouTube</a>
                            <a href="https://wayground.com/home-v1?lng=pt-BR" target="_blank">Wayground (Quizizz)</a>
                        </div>
                    </li>
                    <li class="dropdown">
                        <a href="#">Informa√ß√µes ‚ñº</a>
                        <div class="dropdown-content">
                            <a href="horario-onibus.html">Hor√°rio do √înibus</a>
                            <a href="calendario-aulas.html">Calend√°rio das Aulas</a>
                            <a href="#" onclick="abrirWhatsApp()">Link do grupo do WhatsApp</a>
                            <a href="endereco-aula.html">Endere√ßo do Local das Aulas</a>
                            <a href="contato.html">Contato</a>
                        </div>
                    </li>
                </ul>
            </nav>
            <div class="user-profile">
                <div class="user-avatar"><img src="img/icon-user.png" height="40px" width="40px" alt="Icone do Perfil"></div>
            </div>
        </header>
        
        <main class="content">
            <h1 class="page-title">üìÖ Calend√°rio das Aulas</h1>
            
            <div class="calendar-container">
                <div class="info-card">
                    <div class="schedule-info">
                        <h2>üïê Hor√°rio Fixo das Aulas</h2>
                        <div class="fixed-schedule">
                            <div class="time-info">
                                <span class="time-label">Hor√°rio:</span>
                                <span class="time-value">19:00 √†s 22:00</span>
                            </div>
                            <div class="duration-info">
                                <span class="duration-label">Dura√ß√£o:</span>
                                <span class="duration-value">3 horas por aula</span>
                            </div>
                        </div>
                    </div>
                    
                    <div id="teacherControls" class="teacher-controls" style="display: none;">
                        <h3>üë®‚Äçüè´ Controles do Professor</h3>
                        <div class="control-buttons">
                            <button class="action-btn" onclick="adicionarAula()">‚ûï Adicionar Aula</button>
                            <button class="action-btn secondary" onclick="editarAula()">‚úèÔ∏è Editar Aula Selecionada</button>
                            <button class="action-btn danger" onclick="removerAula()">üóëÔ∏è Remover Aula</button>
                        </div>
                    </div>
                    
                    <div class="calendar-grid">
                        <h3>üìã Cronograma das Aulas</h3>
                        <div id="classSchedule" class="class-schedule">
                            </div>
                    </div>
                    
                    <div class="legend">
                        <h3>üìñ Legenda</h3>
                        <div class="legend-items">
                            <div class="legend-item">
                                <span class="legend-color completed"></span>
                                <span>Aula Realizada</span>
                            </div>
                            <div class="legend-item">
                                <span class="legend-color current"></span>
                                <span>Pr√≥xima Aula</span>
                            </div>
                            <div class="legend-item">
                                <span class="legend-color future"></span>
                                <span>Aulas Futuras</span>
                            </div>
                            <div class="legend-item">
                                <span class="legend-color cancelled"></span>
                                <span>Aula Cancelada</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <div id="editModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle"></h3> <button class="close-btn" onclick="fecharModal()">√ó</button>
            </div>
            <div class="modal-body">
                <form id="classForm">
                    <input type="hidden" id="classId"> <div class="form-group">
                        <label for="classTitle">T√≠tulo da Aula:</label>
                        <input type="text" id="classTitle" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="classDate">Data:</label>
                        <input type="date" id="classDate" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="classStatus">Status:</label>
                        <select id="classStatus">
                            <option value="future">Futura</option>
                            <option value="current">Pr√≥xima</option>
                            <option value="completed">Realizada</option>
                            <option value="cancelled">Cancelada</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="classDescription">Descri√ß√£o:</label>
                        <textarea id="classDescription" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="action-btn secondary" onclick="fecharModal()">Cancelar</button>
                <button class="action-btn primary" onclick="salvarAula()">Salvar</button>
            </div>
        </div>
    </div>

    <div id="deleteConfirmModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üóëÔ∏è Confirmar Exclus√£o</h3>
                <button class="close-btn" onclick="fecharDeleteConfirmModal()">√ó</button>
            </div>
            <div class="modal-body">
                <p>Tem certeza de que deseja remover a aula <strong id="deleteClassTitleConfirm"></strong>?</p>
            </div>
            <div class="modal-footer">
                <button class="action-btn danger" onclick="confirmarRemocaoAula()">Remover</button>
                <button class="action-btn secondary" onclick="fecharDeleteConfirmModal()">Cancelar</button>
            </div>
        </div>
    </div>

    <div id="messageModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="messageModalTitle"></h3>
                <button class="close-btn" onclick="closeMessageModal()">√ó</button>
            </div>
            <div class="modal-body">
                <p id="messageModalText"></p>
            </div>
            <div class="modal-footer">
                <button class="action-btn primary" onclick="closeMessageModal()">OK</button>
            </div>
        </div>
    </div>
    
    <script src="script.js"></script>
    <script>
        let allFetchedClasses = [];
        let selectedClassId = null;

        document.addEventListener('DOMContentLoaded', async () => {
            await loadSchedule();
            const userRole = localStorage.getItem('userRole');
            if (userRole === 'teacher') {
                document.getElementById('teacherControls').style.display = 'block';
            }
        });

        async function loadSchedule() {
            const scheduleContainer = document.getElementById('classSchedule');
            scheduleContainer.innerHTML = '';
            try {
                const response = await fetch('http://127.0.0.1:5000/classes');
                if (!response.ok) {
                    throw new Error(`Erro HTTP! Status: ${response.status}`);
                }
                allFetchedClasses = await response.json();
                
                if (allFetchedClasses.length === 0) {
                    scheduleContainer.innerHTML = '<p style="text-align: center; color: #666;">Nenhuma aula cadastrada.</p>';
                    return;
                }

                allFetchedClasses.forEach(classItem => {
                    const classDiv = document.createElement('div');
                    classDiv.className = `class-item ${classItem.status}`;
                    classDiv.dataset.id = classItem.id;

                    classDiv.onclick = () => selectClass(classItem.id);
                    classDiv.style.cursor = 'pointer';
                    
                    const dateObj = new Date(classItem.date + 'T19:00:00');
                    const formattedDate = dateObj.toLocaleDateString('pt-BR', {
                        weekday: 'long',
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    });
                    
                    classDiv.innerHTML = `
                        <div class="class-header">
                            <h4>${classItem.title}</h4>
                            <span class="class-status">${getStatusText(classItem.status)}</span>
                        </div>
                        <div class="class-date">üìÖ ${formattedDate}</div>
                        <div class="class-time">üïê 19:00 √†s 22:00</div>
                        <div class="class-description">${classItem.description || 'Sem descri√ß√£o.'}</div>
                        
                        <div class="forum-section hidden">
                            <h5>Discuss√£o da Aula</h5>
                            <div class="forum-posts" id="forum-posts-${classItem.id}"></div>
                            <div class="forum-add-post">
                                <textarea id="forum-textarea-${classItem.id}" placeholder="Escreva a sua d√∫vida ou coment√°rio..." onclick="event.stopPropagation()"></textarea>
                                <button class="action-btn small" onclick="postForumMessage(${classItem.id}, event)">Enviar</button>
                            </div>
                        </div>
                    `;
                    
                    scheduleContainer.appendChild(classDiv);
                });
            } catch (error) {
                console.error('Erro ao buscar aulas:', error);
                scheduleContainer.innerHTML = '<p style="text-align: center; color: red;">Erro ao carregar o cronograma.</p>';
            }
        }
        
        function getStatusText(status) {
            const statusMap = { 'completed': 'Realizada', 'current': 'Pr√≥xima', 'future': 'Futura', 'cancelled': 'Cancelada' };
            return statusMap[status] || status;
        }
        
        function selectClass(classId) {
            const previouslySelected = document.querySelector('.class-item.selected');
            const newlySelected = document.querySelector(`.class-item[data-id="${classId}"]`);

            if (previouslySelected && previouslySelected.dataset.id == classId) {
                previouslySelected.querySelector('.forum-section').classList.add('hidden');
                previouslySelected.classList.remove('selected');
                selectedClassId = null;
                return;
            }

            document.querySelectorAll('.forum-section').forEach(forum => forum.classList.add('hidden'));
            document.querySelectorAll('.class-item').forEach(item => item.classList.remove('selected'));
            
            if (newlySelected) {
                newlySelected.classList.add('selected');
                const forumSection = newlySelected.querySelector('.forum-section');
                if(forumSection){
                    forumSection.classList.remove('hidden');
                    loadForumPosts(classId);
                }
            }
            selectedClassId = classId;
        }

        async function loadForumPosts(classId) {
            const postsContainer = document.getElementById(`forum-posts-${classId}`);
            if (!postsContainer) return;

            postsContainer.innerHTML = '<p>A carregar mensagens...</p>';
            try {
                const response = await fetch(`http://127.0.0.1:5000/forum/posts/${classId}`);
                const posts = await response.json();

                postsContainer.innerHTML = '';
                if (posts.length === 0) {
                    postsContainer.innerHTML = '<p style="font-size: 0.9rem; color: #888;">Nenhuma mensagem nesta discuss√£o ainda.</p>';
                    return;
                }

                posts.forEach(post => {
                    const postElement = document.createElement('div');
                    postElement.className = 'forum-post';
                    const dataPostagem = new Date(post.data_postagem).toLocaleString('pt-BR');
                    postElement.innerHTML = `
                        <p class="post-message">
                            <strong class="post-author">${post.autor || 'Utilizador'}</strong>
                            <span class="post-meta">em ${dataPostagem}</span><br>
                            ${post.mensagem}
                        </p>`;
                    postsContainer.appendChild(postElement);
                });
            } catch (error) {
                postsContainer.innerHTML = '<p style="color: red;">Erro ao carregar mensagens.</p>';
            }
        }

        async function postForumMessage(classId, event) {
            event.stopPropagation();
            const textarea = document.getElementById(`forum-textarea-${classId}`);
            const mensagem = textarea.value.trim();
            const userId = localStorage.getItem('userId');

            if (!mensagem) {
                showMessageModal('Aten√ß√£o', 'A mensagem n√£o pode estar vazia.', 'warning');
                return;
            }

            try {
                const response = await fetch('http://127.0.0.1:5000/forum/posts/add', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ class_id: classId, user_id: userId, mensagem: mensagem })
                });
                const data = await response.json();
                if (data.success) {
                    textarea.value = '';
                    await loadForumPosts(classId);
                } else { throw new Error(data.message); }
            } catch (error) {
                showMessageModal('Erro', 'N√£o foi poss√≠vel enviar a sua mensagem.', 'error');
            }
        }
        
        // Fun√ß√µes de Modal para o Professor (sem altera√ß√µes)
        function adicionarAula() {
            selectedClassId = null;
            document.getElementById('modalTitle').textContent = '‚ûï Adicionar Nova Aula';
            document.getElementById('classForm').reset();
            document.getElementById('editModal').classList.remove('hidden');
        }
        
        async function editarAula() {
            if (!selectedClassId) { showMessageModal('Aten√ß√£o', 'Selecione uma aula para editar.'); return; }
            const response = await fetch(`http://127.0.0.1:5000/classes/${selectedClassId}`);
            if (response.ok) {
                const classItem = await response.json();
                document.getElementById('modalTitle').textContent = '‚úèÔ∏è Editar Aula';
                document.getElementById('classId').value = classItem.id;
                document.getElementById('classTitle').value = classItem.title;
                document.getElementById('classDate').value = classItem.date;
                document.getElementById('classStatus').value = classItem.status;
                document.getElementById('classDescription').value = classItem.description || '';
                document.getElementById('editModal').classList.remove('hidden');
            } else { showMessageModal('Erro', 'Aula n√£o encontrada.'); }
        }
        
        function removerAula() {
            if (!selectedClassId) { showMessageModal('Aten√ß√£o', 'Selecione uma aula para remover.'); return; }
            const classItem = allFetchedClasses.find(c => c.id === selectedClassId);
            if (classItem) {
                document.getElementById('deleteClassTitleConfirm').textContent = classItem.title;
                document.getElementById('deleteConfirmModal').classList.remove('hidden');
            }
        }

        async function confirmarRemocaoAula() {
            try {
                const response = await fetch(`http://127.0.0.1:5000/classes/delete/${selectedClassId}`, { method: 'DELETE' });
                const data = await response.json();
                if (data.success) {
                    showMessageModal('Sucesso', 'Aula removida com sucesso!');
                    fecharDeleteConfirmModal();
                    await loadSchedule();
                    selectedClassId = null;
                } else { throw new Error(data.message); }
            } catch (error) { showMessageModal('Erro', 'Erro ao remover aula: ' + error.message); }
        }
        
        async function salvarAula() {
            const title = document.getElementById('classTitle').value;
            const date = document.getElementById('classDate').value;
            const status = document.getElementById('classStatus').value;
            const description = document.getElementById('classDescription').value;
            if (!title || !date) { showMessageModal('Aten√ß√£o', 'T√≠tulo e Data s√£o obrigat√≥rios.'); return; }
            const classData = { title, date, status, description };
            let url = 'http://127.0.0.1:5000/classes/add';
            let method = 'POST';
            if (selectedClassId) {
                url = `http://127.0.0.1:5000/classes/edit/${selectedClassId}`;
                method = 'PUT';
            }
            try {
                const response = await fetch(url, { method, headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(classData) });
                const data = await response.json();
                if (data.success) {
                    showMessageModal('Sucesso', `Aula ${selectedClassId ? 'atualizada' : 'adicionada'} com sucesso!`);
                    fecharModal();
                    await loadSchedule();
                } else { throw new Error(data.message); }
            } catch (error) { showMessageModal('Erro', `Erro ao salvar aula: ` + error.message); }
        }
        
        function fecharModal() {
            document.getElementById('editModal').classList.add('hidden');
            document.getElementById('classForm').reset();
            selectedClassId = null;
        }

        function fecharDeleteConfirmModal() {
            document.getElementById('deleteConfirmModal').classList.add('hidden');
        }
    </script>
    
    <style>
        /* ... estilos existentes ... */
        .calendar-container { max-width: 1000px; margin: 0 auto; }
        .info-card { background: white; border-radius: 15px; padding: 30px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); }
        .schedule-info { background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 30px; }
        .schedule-info h2 { color: #4a90e2; margin-bottom: 15px; }
        .fixed-schedule { display: flex; gap: 30px; flex-wrap: wrap; }
        .time-info, .duration-info { display: flex; flex-direction: column; gap: 5px; }
        .time-label, .duration-label { font-weight: bold; color: #666; }
        .time-value, .duration-value { font-size: 1.2rem; color: #4a90e2; font-weight: bold; }
        .teacher-controls { background: #fff3cd; padding: 20px; border-radius: 10px; margin-bottom: 30px; border: 1px solid #ffeaa7; }
        .teacher-controls h3 { color: #856404; margin-bottom: 15px; }
        .control-buttons { display: flex; gap: 10px; flex-wrap: wrap; }
        .class-schedule { display: flex; flex-direction: column; gap: 15px; }
        .class-item { border: 2px solid #f0f0f0; border-radius: 12px; padding: 20px; cursor: pointer; transition: all 0.3s; }
        .class-item:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); }
        .class-item.selected { border-color: #4a90e2; background: #f0f8ff; }
        .class-item.completed { border-left: 5px solid #28a745; }
        .class-item.current { border-left: 5px solid #ffc107; background: #fff8e1; }
        .class-item.future { border-left: 5px solid #6c757d; }
        .class-item.cancelled { border-left: 5px solid #dc3545; opacity: 0.7; }
        .class-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .class-header h4 { margin: 0; color: #333; }
        .class-status { background: #e9ecef; padding: 4px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: bold; }
        .class-date, .class-time { color: #666; margin-bottom: 5px; }
        .class-description { color: #555; font-style: italic; }
        .legend { margin-top: 30px; padding-top: 20px; border-top: 2px solid #f0f0f0; }
        .legend h3 { color: #333; margin-bottom: 15px; }
        .legend-items { display: flex; gap: 20px; flex-wrap: wrap; }
        .legend-item { display: flex; align-items: center; gap: 8px; }
        .legend-color { width: 20px; height: 4px; border-radius: 2px; }
        .legend-color.completed { background: #28a745; }
        .legend-color.current { background: #ffc107; }
        .legend-color.future { background: #6c757d; }
        .legend-color.cancelled { background: #dc3545; }
        .action-btn.danger { background: #dc3545; }
        .action-btn.danger:hover { background: #c82333; }
        
        .forum-section { margin-top: 20px; padding-top: 15px; border-top: 1px solid #eee; }
        .forum-section h5 { color: #4a90e2; margin-bottom: 10px; }
        .forum-posts { display: flex; flex-direction: column; gap: 12px; max-height: 300px; overflow-y: auto; padding: 10px; background-color: #f8f9fa; border-radius: 8px; margin-bottom: 15px; }
        .forum-post { padding: 10px; background-color: #fff; border-radius: 6px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .post-author { font-weight: bold; color: #333; font-size: 0.9rem; }
        .post-meta { font-size: 0.75rem; color: #888; margin-left: 8px; }
        .post-message { margin-top: 5px; font-size: 0.95rem; color: #555; }
        .forum-add-post { display: flex; flex-direction: column; gap: 10px; }
        .forum-add-post textarea { width: 100%; min-height: 60px; padding: 8px; border: 2px solid #e0e0e0; border-radius: 8px; font-family: inherit; font-size: 0.9rem; }
        .forum-add-post .action-btn { align-self: flex-end; }

        @media (max-width: 768px) {
            .fixed-schedule { flex-direction: column; gap: 15px; }
            .control-buttons { flex-direction: column; }
            .class-header { flex-direction: column; align-items: flex-start; gap: 10px; }
            .legend-items { flex-direction: column; gap: 10px; }
        }
    </style>
</body>
</html>