<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Di√°rio de Classe - Curso de Scratch</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div id="confirmModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="confirmModalTitle"></h3>
                <button class="close-btn" onclick="closeConfirmModal()">√ó</button>
            </div>
            <div class="modal-body">
                <p id="confirmModalText"></p>
            </div>
            <div class="modal-footer">
                <button id="confirmCancelBtn" class="action-btn secondary" onclick="closeConfirmModal()">Cancelar</button>
                <button id="confirmOkBtn" class="action-btn danger">Confirmar</button>
            </div>
        </div>
    </div>
    <div id="messageModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="messageModalTitle"></h3>
                <button class="close-btn" onclick="closeMessageModal()">√ó</button>
            </div>
            <div class="modal-body">
                <p id="messageModalText"></p>
            </div>
            <div class="modal-footer">
                <button class="action-btn primary" onclick="closeMessageModal()">OK</button>
            </div>
        </div>
    </div>
    <div class="main-layout">
        <header class="header">
            <div class="logo">
                <img src="img/scratch.png" height="150" width="150" alt="Scratch Logo" id="scratch-logo">
            </div>
            <nav>
                <ul class="nav-menu">
                    <li id="navAdmin"><a href="admin.html">Administra√ß√£o de Usu√°rios</a></li>
                    <li id="navBancoDados"><a href="database.html">Banco de Dados</a></li>
                    <li id="navDiarioClasseProf"><a href="teacher-diary.html">Di√°rio de Classe</a></li>
                    <li id="navMateriaisProf"><a href="teacher-materials.html">Materiais</a></li>
                    
                    <li class="dropdown">
                        <a href="#">Links Externos ‚ñº</a>
                        <div class="dropdown-content">
                            <a href="https://scratch.mit.edu/" target="_blank">Scratch Website</a>
                            <a href="https://scratch.mit.edu/projects/editor/" target="_blank">Editor do Scratch</a>
                            <a href="https://scratch.mit.edu/ideas" target="_blank">Ideias de Projetos</a>
                            <a href="https://www.youtube.com/results?search_query=scratch+tutorial+portugu√™s" target="_blank">Tutoriais YouTube</a>
                            <a href="https://wayground.com/home-v1?lng=pt-BR" target="_blank">Wayground (Quizizz)</a>
                        </div>
                    </li>
                    <li class="dropdown">
                        <a href="#">Informa√ß√µes ‚ñº</a>
                        <div class="dropdown-content">
                            <a href="horario-onibus.html">Hor√°rio do √înibus</a>
                            <a href="calendario-aulas.html">Calend√°rio das Aulas</a>
                            <a href="#" onclick="abrirWhatsApp()">Link do grupo do WhatsApp</a>
                            <a href="endereco-aula.html">Endere√ßo do Local das Aulas</a>
                            <a href="contato.html">Contato</a>
                        </div>
                    </li>
                </ul>
            </nav>
            <div class="user-profile">
                <div class="user-avatar"><img src="img/icon-user.png" height="40px" width="40px" alt="Icone do Perfil"></div>
            </div>
        </header>
        
        <main class="content">
            <h1 class="page-title">üóìÔ∏è Di√°rio de Classe</h1>
            
            <div class="attendance-controls">
                <div class="form-group">
                    <label for="classSelect">Selecionar Aula:</label>
                    <select id="classSelect" onchange="loadAttendanceForSelectedClass()">
                        <option value="">-- Selecione uma aula --</option>
                    </select>
                </div>
                <button class="action-btn primary" onclick="saveAttendance()">Salvar Presen√ßa</button>
            </div>

            <div class="attendance-table-container">
                <h2>Lista de Presen√ßa</h2>
                <table class="database-table">
                    <thead>
                        <tr>
                            <th>ID do Aluno</th>
                            <th>Nome do Aluno</th>
                            <th>Status da Presen√ßa</th>
                        </tr>
                    </thead>
                    <tbody id="attendanceTableBody">
                        </tbody>
                </table>
                 <div class="pagination-controls" id="paginationControls"></div>
            </div>
        </main>
    </div>

    <script src="script.js"></script>
    <script>
        let allClasses = [];
        let currentAttendanceRecords = [];
        let attendanceState = {}; // Guarda as altera√ß√µes de presen√ßa
        

        document.addEventListener('DOMContentLoaded', async () => {
            await fetchClasses();
            // A busca de alunos agora acontece quando uma aula √© selecionada
        });

        async function fetchClasses() {
            try {
                const response = await fetch('http://127.0.0.1:5000/classes');
                if (!response.ok) throw new Error(`Erro HTTP! Status: ${response.status}`);
                allClasses = await response.json();
                populateClassSelect(allClasses);
            } catch (error) {
                console.error('Erro ao buscar aulas:', error);
                if (window.showMessageModal) showMessageModal('Erro', 'N√£o foi poss√≠vel carregar a lista de aulas.');
            }
        }

        function populateClassSelect(classes) {
            const selectElement = document.getElementById('classSelect');
            selectElement.innerHTML = '<option value="">-- Selecione uma aula --</option>';
            classes.forEach(cls => {
                const option = document.createElement('option');
                option.value = cls.id;
                option.textContent = `${cls.title} (${new Date(cls.date).toLocaleDateString('pt-BR')})`;
                selectElement.appendChild(option);
            });
        }

        async function loadAttendanceForSelectedClass() {
            const selectedClassId = document.getElementById('classSelect').value;
            const attendanceTableBody = document.getElementById('attendanceTableBody');
            attendanceTableBody.innerHTML = '';
            document.getElementById('paginationControls').innerHTML = ''; // Limpa a pagina√ß√£o

            if (!selectedClassId) {
                currentAttendanceRecords = [];
                attendanceState = {}; // Limpa o estado
                return;
            }

            try {
                // 1. Busca todos os registos de presen√ßa para a aula selecionada
                const response = await fetch('http://127.0.0.1:5000/attendance');
                if (!response.ok) throw new Error(`Erro HTTP! Status: ${response.status}`);
                const allAttendance = await response.json();
                currentAttendanceRecords = allAttendance.filter(record => record.class_id == selectedClassId);
                
                // 2. Inicializa o estado com os dados do banco de dados
                attendanceState = {};
                currentAttendanceRecords.forEach(rec => {
                    attendanceState[rec.student_id] = rec.attendance_status;
                });

                // 3. Carrega a primeira p√°gina de alunos
                fetchStudentsForDiary(1);

            } catch (error) {
                console.error('Erro ao buscar registos de presen√ßa:', error);
                if (window.showMessageModal) showMessageModal('Erro', 'N√£o foi poss√≠vel carregar os registos de presen√ßa para esta aula.');
            }
        }

        async function fetchStudentsForDiary(page = 1) {
            currentPage = page;
            const selectedClassId = document.getElementById('classSelect').value;
            if (!selectedClassId) return;

            try {
                const response = await fetch(`http://127.0.0.1:5000/alunos?page=${page}&limit=${rowsPerPage}`);
                if (!response.ok) throw new Error(`Erro HTTP! Status: ${response.status}`);
                const data = await response.json();

                displayAttendanceTable(data.alunos, selectedClassId);
                setupPaginationForDiary(data.total, page);

            } catch (error) {
                 console.error('Erro ao buscar alunos:', error);
                if (window.showMessageModal) showMessageModal('Erro', 'N√£o foi poss√≠vel carregar a lista de alunos.');
            }
        }

        function displayAttendanceTable(studentsOnPage, selectedClassId) {
            const attendanceTableBody = document.getElementById('attendanceTableBody');
            attendanceTableBody.innerHTML = '';

            if (studentsOnPage.length === 0) {
                attendanceTableBody.innerHTML = `<tr><td colspan="3" style="text-align: center;">Nenhum aluno encontrado.</td></tr>`;
                return;
            }

            studentsOnPage.forEach(student => {
                const row = document.createElement('tr');
                // O status atual vem do nosso objeto de estado, ou 'F' (Falta) por defeito
                const currentStatus = attendanceState[student.id] || 'F';

                row.innerHTML = `
                    <td>${student.id}</td>
                    <td>${student.nome}</td>
                    <td>
                        <select class="attendance-status-select" data-student-id="${student.id}" onchange="updateAttendanceState(${student.id}, this.value)">
                            <option value="P" ${currentStatus === 'P' ? 'selected' : ''}>Presente</option>
                            <option value="F" ${currentStatus === 'F' ? 'selected' : ''}>Falta</option>
                            <option value="Fj" ${currentStatus === 'Fj' ? 'selected' : ''}>Falta Justificada</option>
                        </select>
                    </td>
                `;
                attendanceTableBody.appendChild(row);
            });
        }
        
        // Fun√ß√£o para guardar a altera√ß√£o de um aluno no nosso objeto de estado
        function updateAttendanceState(studentId, newStatus) {
            attendanceState[studentId] = newStatus;
        }

        function setupPaginationForDiary(totalItems, currentPage) {
            const paginationControls = document.getElementById('paginationControls');
            paginationControls.innerHTML = '';
            const totalPages = Math.ceil(totalItems / rowsPerPage);

            const prevBtn = document.createElement('button');
            prevBtn.textContent = '¬´ Anterior';
            prevBtn.className = 'action-btn small';
            prevBtn.disabled = currentPage === 1;
            prevBtn.onclick = () => fetchStudentsForDiary(currentPage - 1);
            paginationControls.appendChild(prevBtn);

            let startPage = Math.max(1, currentPage - 2);
            let endPage = Math.min(totalPages, currentPage + 2);

            if (startPage > 1) { paginationControls.appendChild(document.createTextNode('...')); }
            for (let i = startPage; i <= endPage; i++) {
                const pageBtn = document.createElement('button');
                pageBtn.textContent = i;
                pageBtn.className = 'action-btn small';
                if (i === currentPage) { pageBtn.classList.add('active'); }
                pageBtn.onclick = () => fetchStudentsForDiary(i);
                paginationControls.appendChild(pageBtn);
            }
            if (endPage < totalPages) { paginationControls.appendChild(document.createTextNode('...')); }
            
            const nextBtn = document.createElement('button');
            nextBtn.textContent = 'Pr√≥xima ¬ª';
            nextBtn.className = 'action-btn small';
            nextBtn.disabled = currentPage === totalPages;
            nextBtn.onclick = () => fetchStudentsForDiary(currentPage + 1);
            paginationControls.appendChild(nextBtn);
        }

        async function saveAttendance() {
            const selectedClassId = document.getElementById('classSelect').value;
            if (!selectedClassId) {
                if (window.showMessageModal) showMessageModal('Aten√ß√£o', 'Por favor, selecione uma aula antes de salvar a presen√ßa.');
                return;
            }

            const attendanceUpdates = [];
            // Itera sobre o nosso objeto de estado, n√£o sobre a tabela
            for (const studentId in attendanceState) {
                attendanceUpdates.push({
                    student_id: parseInt(studentId),
                    class_id: parseInt(selectedClassId),
                    attendance_status: attendanceState[studentId]
                });
            }

            if (attendanceUpdates.length === 0) {
                showMessageModal('Aviso', 'Nenhuma altera√ß√£o de presen√ßa para salvar.', 'warning');
                return;
            }

            let successCount = 0;
            let errorCount = 0;

            for (const update of attendanceUpdates) {
                try {
                    const response = await fetch('http://127.0.0.1:5000/attendance/add', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(update),
                    });
                    const data = await response.json();
                    if (data.success) {
                        successCount++;
                    } else {
                        errorCount++;
                    }
                } catch (error) {
                    errorCount++;
                }
            }

            if (window.showMessageModal) {
                if (errorCount === 0) {
                    showMessageModal('Sucesso', `Presen√ßa salva para ${successCount} alunos.`);
                } else {
                    showMessageModal('Aten√ß√£o', `Presen√ßa salva para ${successCount} alunos, com ${errorCount} erros.`);
                }
            }
        }
    </script>
</body>
</html>